---
- name: BUILDAH | Test "buildah from" command
  mafalb.buildah.buildah_from:
    name: scratch
  register: from_result

- name: Debug
  ansible.builtin.debug:
    var: from_result.stdout

- name: BUILDAH | Test "buildah mount" command
  mafalb.buildah.buildah_mount:
    name: "{{ from_result.stdout | trim }}"
  register: mount_result

- name: Debug
  ansible.builtin.debug:
    var: mount_result.stdout

- name: Install packages
  ansible.builtin.dnf:
    name: bash,coreutils
    installroot: "{{ mount_result.stdout | replace('\n', '')}}"
    releasever: 29
  register: dnf_result

- name: Debug
  ansible.builtin.debug:
    var: dnf_result

- name: Copy BASH shell script to the rmeote machine
  ansible.builtin.copy:
    src: ./files/runecho.sh
    dest: /tmp/runecho.sh
    owner: root
    group: root
    mode: '0755'
  register: copy_result

- name: Debug
  ansible.builtin.debug:
    var: copy_result

- name: Add a shell script to the image
  mafalb.buildah.buildah_add:
    name: "{{ from_result.stdout | replace('\n', '')}}"
    src: /tmp/runecho.sh
    dest: /usr/local/bin/runecho.sh
  register: add_result

- name: Debug
  ansible.builtin.debug:
    var: add_result

- name: Configure the container meta data
  mafalb.buildah.buildah_config:
    name: "{{ from_result.stdout | replace('\n', '')}}"
    author: ansible-buildah demo
    created_by: ansibles-buildah demo
    comment: This is a bash shell image.
    entrypoint: /usr/local/bin/runecho.sh
  register: config_result

- name: Debug
  ansible.builtin.debug:
    var: config_result

- name: Commit container to an image
  mafalb.buildah.buildah_commit:
    container: "{{ from_result.stdout | replace('\n', '')}}"
    imgname: "{{ imagename }}"
  register: commit_result

- name: Debug
  ansible.builtin.debug:
    var: commit_result

- name: Push image to Registry
  mafalb.buildah.buildah_push:
    name: "{{ imagename }}"
    dest: "{{ registryname }}/{{ imagename }}"
    creds: "{{ registrycreds }}"
  tags:
    - push
  register: push_result

- name: Debug
  ansible.builtin.debug:
    var: push_result
